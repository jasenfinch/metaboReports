
objectName <- function(x){
  deparse(substitute(x))
}

objectTitle <- function(x){
  object_name <- deparse(substitute(x))
  glue(
    "
## {object_name}  
"
  )
} 

loadData <- function(x){
  object_name <- deparse(substitute(x))
  glue(
  "
```{{r loadData}}
{object_name} <- readr::read_rds('data/{object_name}.rds')
```
"
  )
}

argumentNames <- function(...){
  as.character(match.call())
}

setMethod('reportHeader',signature = 'Report',
          function(x){
            toc_option <- x %>%
              toc() %>%
              tolower()
            glue(
"
---
title: {title(x)}
investigator: {investigator(x)}
date: {time(x)}
output: 
  {output(x)}:
    toc: {toc_option}
---
"
            )
          })

setMethod('reportOptions',signature = 'Report',
          function(x){
            glue(
"
```{{r setup,include = FALSE}}
knitr::opts_chunk$set(fig.align = 'center',
                      cache = {cache(x)},
                      echo = {echo(x)})
```
"
            )
          })

setMethod('sessionInformationSection',signature = 'Report',
          function(x){
            if (sessionInformation(x)) {
              si <- glue(
'
## Session Info

```{{r sessionInfo}}
sessionInfo()
```
'
              )
            } else {
              si <- ''
            }
            
            return(si)
          })

setMethod('reportFooter',signature = 'Report',
          function(x){
            package_version <- packageVersion('metaboReports') %>% as.character()
            url <- packageDescription('metaboReports')$URL
            
            glue(
"
-----------
Generated by [metaboReports]({url}) v{package_version}
"
            )
          })

#' @importFrom stringr str_replace_all
#' @importFrom rstudioapi initializeProject isAvailable
#' @importFrom readr write_file write_rds
#' @importFrom purrr walk

setMethod('reportDirectory',signature = 'Report',
          function(x){
            
            message('Creating report directory')
            
            report_title <-  x %>%
              title() %>%
              str_replace_all(' ','_')
            
            report_path <- glue("{path(x)}/{report_title}")
            
            glue("{report_path}/data") %>%
            dir.create(recursive = TRUE)
            
            message('Saving report data')
            
            if (isAvailable()) {
              initializeProject(report_path) 
            }
            
            report_rmd <- reportRMD(x)
            
            write_file(report_rmd,glue("{report_path}/{report_title}.Rmd"))
            
            report_data <- reportData(x)
            
            report_data %>%
              names() %>%
              walk(~{
                write_rds(report_data[[.x]],glue("{report_path}/data/{.x}.rds"))
              })
          })

